# Dataspace ODRL Prototype

This project is a minimal demonstration of ODRL-based authorization in a data space.
It shows how an ODRL JSON policy is converted into a Rego rule, uploaded to OPA,
and enforced through APISIX.

---

## Components

### APISIX
Routes all /data/* requests to the PAP.

### PAP (Policy Administration Point)
- POST /policies — accepts ODRL JSON
- converts constraints into Rego code
- uploads the Rego to OPA
- handles GET /data/test and asks OPA for a decision

### OPA (Open Policy Agent)
Evaluates the Rego policy generated by the PAP.

### Mock Data Service
Returns a static HTML page when access is allowed.

---

## Architecture

Client → APISIX → PAP → OPA → PAP → (mock-data or 403)

---

## Repository Layout

```
dataspace-odrl/
├── docker-compose.yml
├── apisix/
│   └── conf/apisix.yaml
├── pap/
│   ├── server.js
│   ├── Dockerfile
│   └── policies/
│       ├── eindhoven-ict.json
│       └── generated/
│           └── eindhoven-ict.rego
├── opa/
└── mock-data/
    └── index.html
```

---

## Policy Loading Flow

1. Client POSTs an ODRL policy to PAP.
2. PAP extracts constraints such as:
   - leftOperand: "role"
   - operator: "eq"
   - rightOperand: "ICT"
3. PAP generates a Rego policy with these conditions.
4. PAP uploads the Rego to OPA using `PUT /v1/policies/<id>`.
5. OPA compiles the policy and starts enforcing it.
6. A GET request to /data/test goes through:
   - APISIX → PAP → OPA → allow/deny

---

## Testing Instructions

### 1. Start the system

Run:

```
docker compose up --build
```

Wait until:
- PAP is running on port 3000
- OPA is running on port 8181
- APISIX is available on 9080

---
# Delete the existing policy in OPA
```
curl -X DELETE http://localhost:3000/policies/eindhoven
```
# Reload the policy from the JSON file
```
curl -X POST http://localhost:3000/policies \
  -H "Content-Type: application/json" \
  -d @/home/deuthe/dataspace-odrl-green/policies/eindhoven-ict.json
```
---
# Check policies in OPA
```
curl -s http://localhost:8181/v1/policies/eindhoven | jq -r '.result.raw'
```
---

### 2. Load the example ODRL policy

```
curl -X POST http://localhost:3000/policies \
  -H "Content-Type: application/json" \
  -d @policies/eindhoven-ict.json
```

Expected response:

```
{"success": true}
```

Verify the policy in OPA:

```
curl http://localhost:8181/v1/policies/eindhoven
```

---

### 3. Test allowed access

```
curl http://localhost:3000/data/test   -H "X-Attributes-role: ICT"   -H "X-Attributes-gemeente: Eindhoven"
```

Expected:
- HTML page from mock-data  
- HTTP 200

---

### 4. Test forbidden access

```
curl http://localhost:3000/data/test   -H "X-Attributes-role: STUDENT"   -H "X-Attributes-gemeente: Eindhoven"
```

Expected:
- Forbidden by ODRL policy  
- HTTP 403

---

### 5. Modify or reload a policy

Edit the JSON file:

```
pap/policies/eindhoven-ict.json
```

Then reload it:

```
curl -X POST http://localhost:3000/policies \
  -H "Content-Type: application/json" \
  -d @/home/deuthe/dataspace-odrl-green/policies/eindhoven-ict.json
```

---

### 6. Debugging

Check OPA logs:

```
docker logs dataspace-odrl-green-opa-1
```

Check PAP logs:

```
docker logs dataspace-odrl-green-pap-1
```

---

## Notes

- The active policy in OPA is stored under the ID `eindhoven`.
